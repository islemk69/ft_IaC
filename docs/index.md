# Welcome to ft_iac

ft_iac is a school project aimed to discover the world of infrastructure-as-code.

<br>

## Infrastructure-as-code

*Or the return of config files*

<br>

When creating server, with compute instance, databases, virtual network, on a Cloud Provider, the old way was to do all by hand. 
Facing the sisyphean effort, one could make a bunch of scripts, if an API was provided, to automate the process.
But these approach are error prone, slow and need a precise comprehension of the Cloud Provider internals.

Infrastructure-as-code is a paradigm where provisioning and deployment is done declaratively.

Instead of dozens of commands wrote manually by a user, scripts running commands step by step or a deployer creating instances one by one in the cloud provider web interface everything is declared inside a (or multiple) file.

This means we declare the state of what we want, and not how to get to this state.
We then use a tool (in our case, [Terraform](https://developer.hashicorp.com/terraform)) which know the step to create and configure our instances, routers, etc.

<br>

## Our project

For this project we choose Terraform, for it is the most common IaC tool used in professional world, and Google Cloud because it's free offer is very good for beginning and experimentation.

<br>

## Architecture 

We use a multi instance architecture with one database. Each instance is managed via a Group Instance Manager, and is behind a proxy and a load balancer.
The Group Instance Manager is used by an Autoscaler to scale the number of instance based of the current load.

![infrastructure architecture](iac_arch-small.png)

<br>

## Deployment

<br>

### Prerequisites

- Google Cloud account with billing enabled.
- `gcloud` CLI installed 
- `gcloud` CLI authenticated (with `gcloud auth application-default login`)
- `terraform` installed

<br>

### Initialization

Initializes the working directory 
```bash
terraform init
```

<br>

### Configure Variables

Copy the example variables file:
```bash
cp terraform.tfvars.example terraform.tfvars
```

Fill with Google Cloud info:

- Your billing account: `billing_account`

- Your project name: `gcp_project_name`

Project related configuration:

- The deployment region: `gcp_region`

- The instance type: `machine_type`

- An email address for alerting: `alert_email`

<br>

#### Possibles values

| | | |
|----------|-----------------|---------|
| `gcp_region` | Deployment Region  |  `US`, `Europe`, `Asia` |
| `machine_type` | Instance Size  |  `small`, `medium`, `large` |

<br>

### Deploy and destroy

Deployment and deletion is done via Terraform cli, for each creative/destructive command, you'll be asked to confirm.

Deploy configuration:
```bash
terraform apply
```
The resource creation can take a good amount of time, like 15-20 min for a database.

See the current status with:
```bash
terraform show
```

Destroy all resources with:
```bash
terraform destroy
```

Be careful, *all resources* means the database too.

<br>

## Code organization

The `main.tf` is the entrypoint, it load all module and configure them.

- `terraform.tfvars`: where to put your project env (API key, instance type..)
- `.terraform.lock.hcl`: file generated by terraform, used to lock infra config
- `terraform.tfstate{.backup}`: state file describing the stack state 
- `module/`: the Terraform module
- `iac-doc/`: the project documentation


Modules:
- **autoscaling**: manage compute instance (creation, configuration, scaling..)
- **database**: the SQL database for our instance
- **loadbalancer**: network entrypoint, with a proxy and a loadbalancer
- **monitoring**: alerting service
- **network**: the Virtual Private Cloud
- **project**: the Google Cloud Project, where all resource are created

<br>

## Development

<br>

### Cheatsheet

Destroy only some resource with:
```bash
terraform destroy -target module.module_name
```

Practically, it is used only to destroy the compute instance :
```bash
terraform destroy -target module.autoscaling
```

For some errors when creation, Terraform will loose the track of some resource. These resources need then to be deleted manually, using  `gcloud`.
A simple way to clear everything is to delete the Google Cloud Project and delete the `terraform.tfstate{.backup}` file(s)

<br>

### Providers

[Google Cloud](https://cloud.google.com/?hl=en)

[HashiCorp](https://registry.terraform.io/providers/hashicorp/random/latest)
